<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œí‘œ ì˜ìƒ ë¶„ì„ê¸° (FastAPI)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg:#f6f8fa; --card:#fff; --mono:ui-monospace, SFMono-Regular, Menlo, monospace; --bar:#e5e7eb; --fill:#3b82f6; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: #333; max-width: 1200px; margin: 20px auto; padding: 0 20px; line-height: 1.6; }
        h1 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .card { background: var(--card); border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); padding: 25px; margin-top: 20px; }
        
        .layout-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; margin-top: 20px; }
        form { display: flex; flex-direction: column; gap: 15px; }
        input[type="file"] { padding: 10px; border: 2px dashed #ddd; border-radius: 5px; cursor: pointer; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #2980b9; }

        #loading { display: none; text-align: center; font-weight: bold; color: #555; }
        #loading-text { font-size: 1.1em; color: #34495e; margin-top: 10px; }
        
        #transcript-report { display: none; }
        #ai-report-placeholder {
            background: #fdfdfd; padding: 0 20px; border-radius: 5px; 
            border-bottom: 1px dashed #ccc; margin-bottom: 15px;
        }
        #ai-report-placeholder h1, #ai-report-placeholder h2 { border-bottom: 1px solid #eee; }
        #transcript-content { background-color: #fdfdfd; border: 1px solid #eee; border-radius: 5px; padding: 20px; max-height: 800px; overflow-y: auto; }
        #transcript-content .segment {
            padding: 10px; border-radius: 5px; margin-bottom: 8px;
            cursor: pointer; transition: background-color 0.2s;
        }
        #transcript-content .segment:hover { background-color: #f0f4f8; }
        #transcript-content .segment.active { background-color: #ddeafe; border-left: 4px solid #3b82f6; }
        #transcript-content .segment-time { font-family: var(--mono); font-size: 0.9em; color: #64748b; }
        #transcript-content .segment-text { font-size: 1.1em; margin: 4px 0; }
        
        #segment-popover {
            display: none; position: absolute; background: #333; color: white;
            padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100; width: 280px; font-size: 0.95em;
        }
        #segment-popover h4 { margin: 0 0 10px; padding-bottom: 5px; border-bottom: 1px solid #555; }
        #segment-popover .pop-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        
        .error { color: #e74c3c; font-weight: bold; }

        #playback-ui { display: none; }
        video { width: 100%; max-height: 520px; background:#000; border-radius: 10px; margin-bottom: 15px; }
        .panel { border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
        .grid3 { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-bottom: 12px; }
        .kpi { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .k { border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
        .k h4 { margin:0 0 4px; font-size:14px; color:#334155; display:flex; justify-content:space-between; }
        .bar { width:100%; height:10px; background:var(--bar); border-radius:999px; overflow:hidden; }
        .fill { height:100%; background:var(--fill); width:0%; transition: width 0.1s linear; }
        
        /* â­ï¸ [ì¶”ê°€] Jitter/Shimmerìš© ê²½ê³ ìƒ‰ ë°” */
        .bar.warn { --bar:#fef3c7; } 
        .fill.warn { --fill:#f59e0b; }

        .num { font-family: var(--mono); color:#111827; }
        .muted { color:#64748b; font-size:.92rem; }
        
        .toggle { margin:15px 0 8px; display:flex; align-items:center; gap:8px; cursor: pointer; }
        table { width:100%; border-collapse:collapse; font-family:var(--mono); }
        td { padding:4px 6px; border-bottom:1px dashed #e5e7eb; font-size:12px; }
        td.r { text-align:right; color:#000; font-weight: 500;}

        /* â­ï¸ [ì‹ ê·œ] ì±„ì  ê¸°ì¤€ UI ìŠ¤íƒ€ì¼ */
        .criteria-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fcfcfc;
        }
        .criteria-row input[type="text"],
        .criteria-row input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
        }
        .criteria-row input[name="criteria-name"] {
            flex-grow: 1;
        }
        .criteria-row input[name="criteria-desc"] {
            flex-grow: 3;
        }
        .criteria-row input[name="criteria-score"] {
            width: 70px;
            flex-grow: 0;
            text-align: right;
        }
        .criteria-row button {
            padding: 8px 12px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        #addCriteriaButton {
            background-color: #2ecc71;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h1>ğŸ¬ ë°œí‘œ ì˜ìƒ AI ë¶„ì„ê¸°</h1>
    
    <div class="card">
        <h3>1. ë¶„ì„í•  ë™ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ</h3>
        <form id="uploadForm">
            <input type="file" id="videoFile" name="videoFile" accept="video/*" required>

            <div class="card" style="margin-top: 0; box-shadow: none; border: 1px solid #e0e0e0;">
                <h4>2. ğŸ“Š AI ì±„ì  ê¸°ì¤€ ì„¤ì • (1ê°œ ~ ìµœëŒ€ 5ê°œ)</h4>
                <div id="criteriaContainer">
                    </div>
                <button type="button" id="addCriteriaButton">â• ì±„ì  ê¸°ì¤€ ì¶”ê°€ (ìµœëŒ€ 5ê°œ)</button>
                <small style="color: #666; display: block; margin-top: 10px;">* ê¸°ë³¸ 3ê°€ì§€ ê¸°ì¤€ì€ ìë™ìœ¼ë¡œ ì±„ì›Œì§€ë©°, ì‚­ì œ í›„ ìµœëŒ€ 5ê°œê¹Œì§€ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
            </div>
            
            <input type="hidden" id="criteriaJson" name="criteriaJson">
            
            <button type="submit" id="submitButton">AI ë¶„ì„ ì‹œì‘</button>
        </form>
    </div>

    <div id="loading" class="card">
        <p>ğŸ¤– AIê°€ ë™ì˜ìƒì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
        <p id="loading-text">ì„œë²„ì— ì‘ì—… ìš”ì²­ ì¤‘...</p>
    </div>

    <div class="layout-grid">
        
        <div id="playback-ui" class="card">
            <h2>ğŸï¸ ë¶„ì„ ì˜ìƒ ì¬ìƒ</h2>
            <video id="video" controls muted></video>
            <div class="grid3">
                <div class="panel">
                    <div style="font-weight:700">í˜„ì¬ í‘œì •</div>
                    <div id="expr" style="font-size:1.4rem;margin-top:4px">â€”</div>
                    <div id="exprDetail" class="muted">ê·œì¹™ ê¸°ë°˜ ë¶„ë¥˜â€¦</div>
                </div>
                <div class="panel">
                    <div style="font-weight:700">í˜„ì¬ ì‹œì„ </div>
                    <div id="gaze" style="font-size:1.4rem;margin-top:4px">â€”</div>
                    <div id="gazeDetail" class="muted">(ì¢Œ/ìš°/ìƒ/í•˜/ì •ë©´)</div>
                </div>
                <div class="panel">
                    <div style="font-weight:700">í”„ë ˆì„</div>
                    <div style="font-size:1.4rem;margin-top:4px"><span id="time">0.00</span>s</div>
                    <div class="muted">ë¶„ì„ ë°ì´í„° ë™ê¸°í™”</div>
                </div>
            </div>
            <div class="panel" style="margin-top: 15px;">
                <div style="font-weight:700;margin-bottom:8px">ì‹¤ì‹œê°„ í•µì‹¬ ì§€í‘œ</div>
                <div class="kpi">
                    <div class="k"><h4>Smile <span class="num" id="n_smile">0.00</span></h4><div class="bar"><div id="b_smile" class="fill"></div></div></div>
                    <div class="k"><h4>Frown <span class="num" id="n_frown">0.00</span></h4><div class="bar"><div id="b_frown" class="fill"></div></div></div>
                    <div class="k"><h4>BrowUp <span class="num" id="n_brow_up">0.00</span></h4><div class="bar"><div id="b_brow_up" class="fill"></div></div></div>
                    <div class="k"><h4>BrowDown <span class="num" id="n_brow_down">0.00</span></h4><div class="bar"><div id="b_brow_down" class="fill"></div></div></div>
                    <div class="k"><h4>JawOpen <span class="num" id="n_jaw_open">0.00</span></h4><div class="bar"><div id="b_jaw_open" class="fill"></div></div></div>
                    <div class="k"><h4>MouthOpen <span class="num" id="n_mouth_open">0.00</span></h4><div class="bar"><div id="b_mouth_open" class="fill"></div></div></div>
                    <div class="k"><h4>Squint <span class="num" id="n_squint">0.00</span></h4><div class="bar"><div id="b_squint" class="fill"></div></div></div>
                    <div class="k"><h4>Gaze H <span class="num" id="n_gaze_h">0.00</span></h4><div class="bar"><div id="b_gaze_h" class="fill"></div></div></div>
                    <div class="k"><h4>Gaze V <span class="num" id="n_gaze_v">0.00</span></h4><div class="bar"><div id="b_gaze_v" class="fill"></div></div></div>
                    
                    <div class="k">
                        <h4>Jitter (ë–¨ë¦¼) <span class="num" id="n_jitter">0.00%</span></h4>
                        <div class="bar warn"><div id="b_jitter" class="fill warn"></div></div>
                    </div>
                    <div class="k">
                        <h4>Shimmer (ê±°ì¹ ê¸°) <span class="num" id="n_shimmer">0.00%</span></h4>
                        <div class="bar warn"><div id="b_shimmer" class="fill warn"></div></div>
                    </div>
                </div>
            </div>
            <label class="toggle"><input type="checkbox" id="toggleTop"> Top-10 ë¸”ë Œë“œì…°ì´í”„ ë³´ê¸°</label>
            <div id="topWrap" style="display:none; margin-top:8px" class="panel">
                <table id="topTable"></table>
            </div>
        </div>

        <div id="transcript-report" class="card">
            <h2>ğŸ“œ ëŒ€ë³¸ ë° êµ¬ê°„ ë¶„ì„</h2>
            <div id="ai-report-placeholder"></div>
            <div id="transcript-content"></div>
        </div>
    </div>

    <div id="segment-popover">
        <div id="popover-content"></div>
    </div>


    <script>
        // DOM ìš”ì†Œ ìºì‹±
        const uploadForm = document.getElementById('uploadForm');
        const submitButton = document.getElementById('submitButton');
        const videoFile = document.getElementById('videoFile');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const aiReportDiv = document.getElementById('transcript-report');
        const aiReportPlaceholder = document.getElementById('ai-report-placeholder');
        const transcriptContent = document.getElementById('transcript-content');
        const playbackUiDiv = document.getElementById('playback-ui');
        const video = document.getElementById('video');
        const timeEl = document.getElementById('time');
        const exprEl = document.getElementById('expr');
        const exprDetailEl = document.getElementById('exprDetail');
        const gazeEl = document.getElementById('gaze');
        const gazeDetailEl = document.getElementById('gazeDetail');
        const toggleTop = document.getElementById('toggleTop');
        const topWrap = document.getElementById('topWrap');
        const topTable = document.getElementById('topTable');
        const popover = document.getElementById('segment-popover');
        const popoverContent = document.getElementById('popover-content');
        // â­ï¸ ì±„ì  ê¸°ì¤€ ê´€ë ¨ DOM ìš”ì†Œ
        const criteriaContainer = document.getElementById('criteriaContainer');
        const addCriteriaButton = document.getElementById('addCriteriaButton');
        const criteriaJsonInput = document.getElementById('criteriaJson');


        const bars = {
            smile: document.getElementById('b_smile'), frown: document.getElementById('b_frown'),
            brow_up: document.getElementById('b_brow_up'), brow_down: document.getElementById('b_brow_down'),
            jaw_open: document.getElementById('b_jaw_open'), mouth_open: document.getElementById('b_mouth_open'),
            squint: document.getElementById('b_squint'), gaze_h: document.getElementById('b_gaze_h'),
            gaze_v: document.getElementById('b_gaze_v'),
            jitter: document.getElementById('b_jitter'),
            shimmer: document.getElementById('b_shimmer'),
        };
        const nums = {
            smile: document.getElementById('n_smile'), frown: document.getElementById('n_frown'),
            brow_up: document.getElementById('n_brow_up'), brow_down: document.getElementById('n_brow_down'),
            jaw_open: document.getElementById('n_jaw_open'), mouth_open: document.getElementById('n_mouth_open'),
            squint: document.getElementById('n_squint'), gaze_h: document.getElementById('n_gaze_h'),
            gaze_v: document.getElementById('n_gaze_v'),
            jitter: document.getElementById('n_jitter'),
            shimmer: document.getElementById('n_shimmer'),
        };

        let rawData = [];
        let alignedTranscriptData = [];
        let videoObjectUrl = null;
        let pollingInterval = null;

        // â­ï¸ [ì‹ ê·œ] ê¸°ë³¸ ì±„ì  ê¸°ì¤€ ì´ˆê¸°í™” ë° ê´€ë¦¬ ë¡œì§
        const MAX_CRITERIA = 5;
        let criteriaCount = 0;

        function addCriteriaRow(name = '', description = '', score = 10, isInitial = false) {
            if (criteriaCount >= MAX_CRITERIA) {
                if (!isInitial) {
                    alert(`ì±„ì  ê¸°ì¤€ì€ ìµœëŒ€ ${MAX_CRITERIA}ê°œê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                }
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'criteria-row';
            wrapper.dataset.index = criteriaCount;

            wrapper.innerHTML = `
                <input type="text" name="criteria-name" placeholder="ê¸°ì¤€ëª… (ì˜ˆ: ì°½ì˜ë ¥)" value="${name}" required>
                <input type="text" name="criteria-desc" placeholder="ê¸°ì¤€ ì„¤ëª… (GPTê°€ ì±„ì í•  ë•Œ ì°¸ê³ )" value="${description}" required>
                <input type="number" name="criteria-score" placeholder="ë§Œì  ê¸°ì¤€" value="${score}" min="1" max="100" required>
                ${isInitial ? '' : '<button type="button" class="remove-criteria-btn">ì‚­ì œ</button>'}
            `;

            criteriaContainer.appendChild(wrapper);
            criteriaCount++;
            updateCriteriaButtonState();
            
            // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            if (!isInitial) {
                wrapper.querySelector('.remove-criteria-btn').addEventListener('click', (e) => {
                    criteriaContainer.removeChild(wrapper);
                    criteriaCount--;
                    updateCriteriaButtonState();
                    e.stopPropagation(); 
                });
            }
        }
        
        function updateCriteriaButtonState() {
            addCriteriaButton.disabled = criteriaCount >= MAX_CRITERIA;
            addCriteriaButton.textContent = criteriaCount >= MAX_CRITERIA ? `ìµœëŒ€ ${MAX_CRITERIA}ê°œ ì„¤ì •ë¨` : 'â• ì±„ì  ê¸°ì¤€ ì¶”ê°€ (ìµœëŒ€ 5ê°œ)';
        }

        // ê¸°ë³¸ ê¸°ì¤€ ì„¤ì •
        addCriteriaRow('ì‹œì„  ì²˜ë¦¬', 'gaze_h/vê°€ -0.1~0.1 ì‚¬ì´ì¸ ì •ë©´ ì‘ì‹œ ë¹„ìœ¨ì„ í‰ê°€', 25, true);
        addCriteriaRow('í‘œì • ê´€ë¦¬', 'smile, frown ìˆ˜ì¹˜ë¥¼ ë³´ê³  ê¸ì •ì /ë¶€ì •ì  í‘œì •ì„ í‰ê°€', 25, true);
        addCriteriaRow('ì „ë‹¬ë ¥ ë° ì†ë„', 'jitter/shimmer, speech_rate_cpsë¥¼ ê¸°ì¤€ìœ¼ë¡œ ëª©ì†Œë¦¬ ì•ˆì •ì„± ë° ì†ë„ë¥¼ í‰ê°€', 50, true);

        addCriteriaButton.addEventListener('click', () => addCriteriaRow());
        
        // â­ï¸ [ì‹ ê·œ] í¼ ì œì¶œ ì‹œ ê¸°ì¤€ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ìˆ¨ê²¨ì§„ í•„ë“œì— ì €ì¥
        function collectCriteriaData() {
            const criteria = [];
            const rows = criteriaContainer.querySelectorAll('.criteria-row');
            rows.forEach(row => {
                const name = row.querySelector('input[name="criteria-name"]').value.trim();
                const desc = row.querySelector('input[name="criteria-desc"]').value.trim();
                let score = parseInt(row.querySelector('input[name="criteria-score"]').value);
                
                if (name && desc && !isNaN(score) && score > 0) {
                    // ì ìˆ˜ ë²”ìœ„ ì œí•œ
                    score = Math.min(100, Math.max(1, score));
                    criteria.push({ name: name, description: desc, score: score });
                }
            });
            
            // ê¸°ì¤€ì´ í•˜ë‚˜ë„ ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´ì„ ì €ì¥ (ë°±ì—”ë“œì—ì„œ ê¸°ë³¸ ê¸°ì¤€ ì‚¬ìš©)
            criteriaJsonInput.value = criteria.length > 0 ? JSON.stringify(criteria) : "";
        }


        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
        uploadForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // â­ï¸ 1. ê¸°ì¤€ ë°ì´í„° ìˆ˜ì§‘ ë° JSON í•„ë“œ ì—…ë°ì´íŠ¸
            collectCriteriaData();

            const file = videoFile.files[0];
            if (!file) { alert('ë™ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            
            const formData = new FormData();
            formData.append('videoFile', file);
            // â­ï¸ 2. JSON ë¬¸ìì—´ë„ FormDataì— ì¶”ê°€í•˜ì—¬ ì „ì†¡
            formData.append('criteriaJson', criteriaJsonInput.value); 
            
            setLoadingState(true, '0/6: ì„œë²„ì— ì‘ì—… ìš”ì²­ ì¤‘...'); 
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    try { const errorJson = JSON.parse(errorText); throw new Error(errorJson.detail || 'ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨'); } 
                    catch (e) { throw new Error(errorText || 'ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨'); }
                }

                const data = await response.json();
                if (!data.job_id) {
                    throw new Error('ì„œë²„ì—ì„œ ì‘ì—… IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
                pollStatus(data.job_id, file);

            } catch (error) {
                console.error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                showError(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        });

        // Polling í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        function pollStatus(jobId, file) {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${jobId}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        try { const errorJson = JSON.parse(errorText); throw new Error(errorJson.detail || `ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ${response.statusText}`); } 
                        catch (e) { throw new Error(errorText || `ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ${response.statusText}`); }
                    }

                    const data = await response.json();

                    let progressMessage = `ğŸ¤– ${data.message}`;
                    if (data.progress && data.total) {
                        progressMessage += ` (${data.progress}/${data.total} í”„ë ˆì„)`;
                    }
                    loadingText.textContent = progressMessage;

                    if (data.status === 'Complete' || data.status === 'Error') {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        showResults(data.result, file);
                    }
                } catch (error) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.error('Polling ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    showError(`âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                }
            }, 2000);
        }

        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        function showResults(data, file) {
            // 1. AI ë©”ì‹œì§€ í‘œì‹œ (marked.js ì‚¬ìš©)
            if (data.ai_assessment && (data.ai_assessment.ai_feedback || data.ai_assessment.error)) {
                const message = data.ai_assessment.ai_feedback || `<p class="error">${data.ai_assessment.error}</p>`;
                aiReportPlaceholder.innerHTML = marked.parse(message);
                if(data.ai_assessment.error) aiReportPlaceholder.classList.add("error");
                else aiReportPlaceholder.classList.remove("error");
            } else {
                aiReportPlaceholder.innerHTML = `<p class="error">âŒ AI ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>`;
            }
            
            // 2. í”„ë ˆì„ë³„ ì‹œì„ /í‘œì • ë°ì´í„° ì €ì¥
            if (data.raw_data && data.raw_data.length > 0) {
                rawData = data.raw_data.filter(d => !d.error);
            } else {
                aiReportPlaceholder.innerHTML += `<p class="error">âŒ ì›ë³¸ ë°ì´í„°(raw_data)ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
            
            // 3. ëŒ€ë³¸(Transcript) UI ìƒì„±
            transcriptContent.innerHTML = ''; 
            if (data.aligned_transcript_data && data.aligned_transcript_data.length > 0) {
                alignedTranscriptData = data.aligned_transcript_data;
                alignedTranscriptData.forEach((segment, index) => {
                    const segmentEl = document.createElement('div');
                    segmentEl.className = 'segment';
                    segmentEl.dataset.index = index;
                    segmentEl.dataset.start = segment.start;
                    
                    segmentEl.innerHTML = `
                        <div class="segment-time">${segment.start.toFixed(1)}s - ${segment.end.toFixed(1)}s</div>
                        <div class="segment-text">${segment.text}</div>
                    `;
                    
                    segmentEl.addEventListener('click', () => {
                        video.currentTime = segment.start;
                        video.play();
                    });
                    segmentEl.addEventListener('mouseenter', (e) => showPopover(e, segment));
                    segmentEl.addEventListener('mouseleave', () => popover.style.display = 'none');

                    transcriptContent.appendChild(segmentEl);
                });
            } else if (!data.ai_assessment.error) {
                transcriptContent.innerHTML = `<p style="color:#777; font-style: italic;">ìŒì„± ì¸ì‹ ê²°ê³¼(ëŒ€ë³¸)ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            // 4. ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„
            if (videoObjectUrl) URL.revokeObjectURL(videoObjectUrl);
            videoObjectUrl = URL.createObjectURL(file);
            video.src = videoObjectUrl;

            // 5. UI í‘œì‹œ
            setLoadingState(false, '');
            aiReportDiv.style.display = 'block';
            playbackUiDiv.style.display = 'block';
        }
        
        function showError(message) {
            setLoadingState(false, '');
            aiReportDiv.style.display = 'block';
            aiReportPlaceholder.innerHTML = `<p class="error">${message}</p>`; 
            transcriptContent.innerHTML = '';
        }

        // â­ï¸ [ìˆ˜ì •] ë¹„ë””ì˜¤ ì¬ìƒ ì‹œê°„ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ (ìš´ìœ¨ í‘œì‹œ ë¡œì§ ì¶”ê°€)
        video.addEventListener('timeupdate', () => {
            const currentTime = video.currentTime;
            timeEl.textContent = currentTime.toFixed(2) + 's';

            // 1. í”„ë ˆì„ë³„ ë°ì´í„° UI ì—…ë°ì´íŠ¸ (ì‹œì„ /í‘œì •)
            const frame = findClosestFrame(currentTime);
            if (!frame) {
                Object.keys(bars).filter(k => !k.startsWith('jitter') && !k.startsWith('shimmer')).forEach(key => setGauge(key, 0));
                Object.keys(bars).filter(k => k.startsWith('gaze')).forEach(key => setGaugeSigned(key, 0));
                exprEl.textContent = 'â€”'; gazeEl.textContent = 'â€”'; gazeDetailEl.textContent = '';
                topTable.innerHTML = '';
            } else {
                updateAllGauges(frame); 
                updateLabels(frame);    
                if (toggleTop.checked) {
                    updateTop10(frame.all_blendshapes);
                }
            }
            
            // 2. â­ï¸ [ìˆ˜ì •] ëŒ€ë³¸ í•˜ì´ë¼ì´íŠ¸ ë° *êµ¬ê°„ë³„* ìš´ìœ¨(Prosody) UI ì—…ë°ì´íŠ¸
            updateTranscriptAndProsodyHighlight(currentTime);
        });
        
        // â­ï¸ [ìˆ˜ì •] ëŒ€ë³¸ í•˜ì´ë¼ì´íŠ¸ + ìš´ìœ¨ ê²Œì´ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        let lastActiveSegment = null;
        function updateTranscriptAndProsodyHighlight(currentTime) {
            if (alignedTranscriptData.length === 0) return;

            const segments = transcriptContent.querySelectorAll('.segment');
            let currentActiveSegment = null;
            
            for (const segmentEl of segments) {
                const index = segmentEl.dataset.index;
                if (!alignedTranscriptData[index]) continue;
                
                const start = parseFloat(segmentEl.dataset.start);
                const end = parseFloat(alignedTranscriptData[index].end);
                
                if (currentTime >= start && currentTime <= end) {
                    currentActiveSegment = segmentEl;
                    break;
                }
            }
            
            if (currentActiveSegment !== lastActiveSegment) {
                if (lastActiveSegment) lastActiveSegment.classList.remove('active');
                
                if (currentActiveSegment) {
                    currentActiveSegment.classList.add('active');
                    
                    const segmentData = alignedTranscriptData[currentActiveSegment.dataset.index];
                    if (segmentData && segmentData.prosody) {
                        // JitterëŠ” 2.0%ë¥¼ maxë¡œ, ShimmerëŠ” 5.0%ë¥¼ maxë¡œ ì„¤ì •
                        setGauge('jitter', segmentData.prosody.jitter / 2.0); 
                        setGauge('shimmer', segmentData.prosody.shimmer / 5.0);
                        // í…ìŠ¤íŠ¸ëŠ” ì‹¤ì œ % ê°’ìœ¼ë¡œ í‘œì‹œ
                        nums['jitter'].textContent = segmentData.prosody.jitter.toFixed(2) + '%';
                        nums['shimmer'].textContent = segmentData.prosody.shimmer.toFixed(2) + '%';
                    }
                } else {
                    // ëŒ€ë³¸ êµ¬ê°„ì´ ì•„ë‹ ë•Œ(ì‰¼ êµ¬ê°„) ìš´ìœ¨ ê²Œì´ì§€ ì´ˆê¸°í™”
                    setGauge('jitter', 0);
                    setGauge('shimmer', 0);
                    nums['jitter'].textContent = '0.00%';
                    nums['shimmer'].textContent = '0.00%';
                }
                lastActiveSegment = currentActiveSegment;
            }
        }
        
        // â­ï¸ [ìˆ˜ì •] íŒì˜¤ë²„ í‘œì‹œ í•¨ìˆ˜ (ìš´ìœ¨, ì†ë„ ì •ë³´ ì¶”ê°€)
        function showPopover(event, segment) {
            let visionHtml = '';
            if (segment.vision_avg.error) {
                visionHtml = `<p class="error" style="margin: 4px 0;">${segment.vision_avg.error}</p>`;
            } else {
                visionHtml = `
                    <div class="pop-row"><span>í‰ê·  ë¯¸ì†Œ:</span> <strong>${segment.vision_avg.smile.toFixed(2)}</strong></div>
                    <div class="pop-row"><span>í‰ê·  ì°¡ê·¸ë¦¼:</span> <strong>${segment.vision_avg.frown.toFixed(2)}</strong></div>
                    <div class="pop-row"><span>í‰ê·  ì‹œì„ (ì¢Œìš°):</span> <strong>${segment.vision_avg.gaze_h.toFixed(2)}</strong></div>
                    <div class="pop-row"><span>í‰ê·  ì‹œì„ (ìƒí•˜):</span> <strong>${segment.vision_avg.gaze_v.toFixed(2)}</strong></div>
                `;
            }

            popoverContent.innerHTML = `
                <h4>"${segment.text.substring(0, 12)}..."</h4>
                <div class="pop-row"><span>ë°œí‘œ ì†ë„(CPS):</span> <strong>${segment.speech_rate_cps.toFixed(2)}</strong></div>
                <div class="pop-row"><span>ëª©ì†Œë¦¬ ë–¨ë¦¼(Jitter):</span> <strong>${segment.prosody.jitter.toFixed(2)}%</strong></div>
                <div class="pop-row"><span>ëª©ì†Œë¦¬ ê±°ì¹ ê¸°(Shimmer):</span> <strong>${segment.prosody.shimmer.toFixed(2)}%</strong></div>
                <hr style="border:0; border-top:1px dashed #555; margin: 8px 0;">
                ${visionHtml}
            `;

            popover.style.display = 'block';
            
            // íŒì˜¤ë²„ ìœ„ì¹˜ ê³„ì‚° (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
            const popWidth = popover.offsetWidth;
            const popHeight = popover.offsetHeight;
            const margin = 10;
            let left = event.clientX + 15;
            let top = event.clientY - 15;
            
            if (left + popWidth + margin > window.innerWidth) {
                left = event.clientX - popWidth - 15;
            }
            if (top + popHeight + margin > window.innerHeight) {
                top = window.innerHeight - popHeight - margin;
            }
             if (top < margin) {
                top = margin;
            }

            popover.style.left = left + 'px';
            popover.style.top = top + 'px';
        }

        // Top-10 í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        toggleTop.addEventListener('change', () => {
            topWrap.style.display = toggleTop.checked ? 'block' : 'none';
        });

        // â­ï¸ [ìˆ˜ì •] í‘œì •/ì‹œì„  ê²Œì´ì§€ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ (ìš´ìœ¨ ì œì™¸)
        function updateAllGauges(frame) {
            setGauge('smile', frame.smile);
            setGauge('frown', frame.frown);
            setGauge('brow_up', frame.brow_up);
            setGauge('brow_down', frame.brow_down);
            setGauge('jaw_open', frame.jaw_open);
            setGauge('mouth_open', frame.mouth_open);
            setGauge('squint', frame.squint);
            setGaugeSigned('gaze_h', frame.gaze_h);
            setGaugeSigned('gaze_v', frame.gaze_v);
        }

        // Top-10 ë¸”ë Œë“œì…°ì´í”„ í…Œì´ë¸” ê·¸ë¦¬ê¸° (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        function updateTop10(blendshapes) {
            if (!blendshapes) {
                topTable.innerHTML = '';
                return;
            }
            const entries = Object.keys(blendshapes).map(key => ({ name: key, score: blendshapes[key] }));
            entries.sort((a, b) => b.score - a.score);
            const top10 = entries.slice(0, 10);
            topTable.innerHTML = top10.map(item => 
                `<tr><td>${item.name}</td><td class="r">${item.score.toFixed(3)}</td></tr>`
            ).join('');
        }

        // í—¬í¼ í•¨ìˆ˜: ë¡œë”© ìƒíƒœ ì„¤ì • (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        function setLoadingState(isLoading, message) {
            submitButton.disabled = isLoading;
            submitButton.textContent = isLoading ? 'ë¶„ì„ ì¤‘...' : 'AI ë¶„ì„ ì‹œì‘';
            loadingDiv.style.display = isLoading ? 'block' : 'none';
            loadingText.textContent = message;
            
            if (isLoading) {
                aiReportDiv.style.display = 'none';
                playbackUiDiv.style.display = 'none';
                aiReportPlaceholder.innerHTML = '';
                transcriptContent.innerHTML = '';
                rawData = [];
                alignedTranscriptData = [];
                if (pollingInterval) clearInterval(pollingInterval);
            }
        }

        // í—¬í¼ í•¨ìˆ˜: í˜„ì¬ ì‹œê°„ì— ê°€ì¥ ê°€ê¹Œìš´ í”„ë ˆì„ ë°ì´í„° ì°¾ê¸° (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        function findClosestFrame(currentTime) {
            if (rawData.length === 0) return null;
            return rawData.reduce((prev, curr) => {
                return (Math.abs(curr.time - currentTime) < Math.abs(prev.time - currentTime) ? curr : prev);
            });
        }
        
        // í—¬í¼ í•¨ìˆ˜: ë ˆì´ë¸” ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        function updateLabels(frame) {
            const TH = { smile: 0.25, frown: 0.25, brow_down: 0.2, brow_up: 0.3, squint: 0.3 };
            let exprLabel = 'ğŸ˜ ì¤‘ë¦½';
            if (frame.smile > TH.smile && frame.brow_up > 0.15) {
                exprLabel = 'ğŸ˜Š ë¯¸ì†Œ';
            } else if (frame.frown > TH.frown && frame.brow_down > TH.brow_down) {
                exprLabel = 'ğŸ˜  ì°¡ê·¸ë¦¼';
            } else if (frame.squint > TH.squint) {
                exprLabel = 'ğŸ˜‘ ëˆˆ ì°Œí‘¸ë¦¼';
            }
            exprEl.textContent = exprLabel;

            const GH = 0.12, GV = 0.12;
            let gazeLabel = 'ì •ë©´';
            if (Math.abs(frame.gaze_h) < GH && Math.abs(frame.gaze_v) < GV) {
                gazeLabel = 'ì •ë©´';
            } else {
                const horiz = frame.gaze_h > GH ? 'ì¢Œ' : (frame.gaze_h < -GH ? 'ìš°' : '');
                const vert = frame.gaze_v > GV ? 'ìƒ' : (frame.gaze_v < -GV ? 'í•˜' : '');
                gazeLabel = (vert + horiz) || (horiz || vert);
            }
            gazeEl.textContent = gazeLabel;
            gazeDetailEl.textContent = `h=${frame.gaze_h.toFixed(2)}, v=${frame.gaze_v.toFixed(2)}`;
        }

        // í—¬í¼ í•¨ìˆ˜: ê²Œì´ì§€ UI ì„¤ì • (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        function setGauge(key, v) {
            if (!nums[key] || !bars[key]) return;
            const value = v || 0;
            if (key !== 'jitter' && key !== 'shimmer') {
                nums[key].textContent = value.toFixed(3);
            }
            bars[key].style.width = (Math.max(0, Math.min(1, value)) * 100).toFixed(0) + '%';
        }

        // í—¬í¼ í•¨ìˆ˜: -1 ~ 1 ë²”ìœ„ì˜ ê²Œì´ì§€ UI ì„¤ì • (ì‹œì„ ìš©)
        function setGaugeSigned(key, v) {
            if (!nums[key] || !bars[key]) return;
            const value = v || 0;
            nums[key].textContent = value.toFixed(3);
            bars[key].style.width = ((value * 0.5 + 0.5) * 100).toFixed(0) + '%';
        }
    </script>
</body>
</html>